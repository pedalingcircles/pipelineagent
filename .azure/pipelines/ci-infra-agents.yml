name: $(Build.DefinitionName)-$(SourceBranchName)-$(versionSemantic)

variables:
- template: templates/variables-version-semantic.yml
  parameters:
    versionMajor: 1
    versionMinor: 0

trigger:
  batch: true
  branches:
    include:
    - main
  paths:
    include:
    - '/iac/*'

stages:
- stage: lint
  displayName: Lint
  jobs:
  - job: buildLintBicep
    displayName: Lint and Build Bicep Files
    steps:
    - checkout: self
      clean: true
      fetchDepth: 1

    - task: PowerShell@2
      displayName: Validate Bicep Installation
      inputs:
        targetType: 'inline'
        script: |
          az bicep version
          if (0 -ne $LASTEXITCODE) {
            az bicep install
            if (0 -ne $LASTEXITCODE) {
              throw "Failed installing Azure Bicep CLI"
            }
          }
        pwsh: true

    - task: PowerShell@2
      displayName: Build Bicep files
      inputs:
        targetType: 'inline'
        script: |
          az bicep version
          az bicep build --file **/*.bicep
        pwsh: true

    - publish: $(System.DefaultWorkingDirectory)
      artifact: drop-infra
    - script: |
        echo "##vso[build.addbuildtag]infra"
        echo "##vso[build.addbuildtag]pipelineagents"
        echo "##vso[build.addbuildtag]$(versionSemantic)"
        echo "##vso[build.addbuildtag]build"
      displayName: Tag Build