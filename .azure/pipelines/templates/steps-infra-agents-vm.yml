# steps-infra-agents-vm.yml
# Description:
#   Steps template used to provision VM infrastructure.
 
parameters:
# The environemnt type.
- name: environmentType
  type: string
  values:
  - ephemeral
  - sandbox
  - integration
  - development
  - demo
  - test
  - acceptance
  - staging
  - production

# The organization name.
- name: organizationName
  type: string

# The location.
- name: location
  type: string

# The subscription Id.
- name: subscription
  type: string

# The bicep template file path.
- name: templateFilePath
  type: string

# Service Connection name
- name: serviceConnectionName
  type: string

# The storage account name name used 
# to store ephemeral agent installer scripts
- name: agentInstallerStorageAccountName
  type: string

# The storage account container name used 
# to store ephemeral agent installer scripts
- name: agentInstallerContainerName
  type: string

# The source directory path of the 
# the scripts used to install 
# the agent software.
- name: agentInstallerSourcePath
  type: string

# The directory name used inside
# the storage container that temporarily
# is used as a storage location for this pipeline
# run to use so VMs can access the the
# agent installer script. This is cleaned
# up at the end of a pipeline.
- name: agentInstallerDirectory
  type: string

steps:

- checkout: self

- task: DownloadSecureFile@1
  name: caCertificate
  displayName: 'Download Public SSH Key'
  inputs:
    secureFile: 'vmagent-priv-key.pub'

- task: AzureCLI@2
  name: uploadInstallerFiles
  displayName: Upload agent installer script files
  inputs:
    azureSubscription: ${{ parameters.serviceConnectionName }}
    scriptType: 'pscore'
    scriptLocation: 'inlineScript'
    failOnStandardError: true
    inlineScript: |
      az storage blob upload-batch `
          --debug `
          --destination ${{ parameters.agentInstallerContainerName }}/${{ parameters.agentInstallerDirectory }} `
          --source ${{ parameters.agentInstallerSourcePath }} `
          --account-name ${{ parameters.agentInstallerStorageAccountName }} `
          --auth-mode login

- task: AzureCLI@2
  displayName: Provision VM(s)
  inputs:
    azureSubscription: ${{ parameters.serviceConnectionName }}
    scriptType: 'bash'
    scriptLocation: 'inlineScript'
    failOnStandardError: true
    inlineScript: |
      organizationName=$1
      location=$2
      subscription=$3
      environmentType=$4
      templateFilePath=$5
      sshPubKeyFilePath=$6

      publicKey=$(cat "$sshPubKeyFilePath")

      az deployment group create \
        --resource-group 'rg-pipelineagent-sandbox-u63kxyluy6fdo-agent' \
        --name agentVmDeployment \
        --no-prompt true \
        --subscription $subscription \
        --template-file $templateFilePath \
        --parameters \
            environmentType=$environmentType \
            organization=$organizationName \
            resourceGroupName='rg-pipelineagent-sandbox-u63kxyluy6fdo-agent' \
            adminPublicKey="$publicKey" \
            existingSharedImageGalleryName='sig.contoso.images' \
            existingImageResourceGroupName='rg-contoso-images' \
            imageDefinitionName='ubuntu2004' \
            imageDefinitionVersion='1.0.76' \
            existingNetworkSecurityGroupName='nsg-agent' \
            existingVnetName='vnet-agent' \
            existingSubnetName='snet-agent' \
            existingStorageAccountName='stagentpasbxu63kxyluy6fd' \
            scriptExtensionScriptUris='("https://stagentpasbxu63kxyluy6fd.blob.core.windows.net/scriptextensions/hello.sh")'

    arguments: >
      ${{ parameters.organizationName }}
      ${{ parameters.location }}
      ${{ parameters.subscription }}
      ${{ parameters.environmentType }}
      ${{ parameters.templateFilePath }}
      $(caCertificate.secureFilePath)

- task: AzureCLI@2
  displayName: Delete installer script files
  condition: false # always()
  inputs:
    azureSubscription: ${{ parameters.serviceConnectionName }}
    scriptType: 'pscore'
    scriptLocation: 'inlineScript'
    failOnStandardError: true
    inlineScript: |
      az storage blob delete-batch `
          --source ${{ parameters.agentInstallerContainerName }} `
          --pattern ${{ parameters.agentInstallerDirectory }}/* `
          --account-name ${{ parameters.agentInstallerStorageAccountName }} `
          --auth-mode login


