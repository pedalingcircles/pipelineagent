# steps-infra-agents-vm.yml
# Description:
#   Steps template used to provision images infrastructure.
 
parameters:
# The environemnt type.
# Accepted values: sbx, prd
- name: environmentType
  type: string
  values:
  - ephemeral
  - sandbox
  - integration
  - development
  - demo
  - test
  - acceptance
  - staging
  - production

# The organization name.
- name: organizationName
  type: string

# The location.
- name: location
  type: string

# The subscription Id.
- name: subscription
  type: string

# The bicep template file path.
- name: templateFilePath
  type: string

# Service Connection name
- name: serviceConnectionName
  type: string

steps:

- task: DownloadSecureFile@1
  name: caCertificate
  displayName: 'Download Public SSH Key'
  inputs:
    secureFile: 'vmagent-priv-key.pub'

- script: |
    echo Installing $(caCertificate.secureFilePath) to the trusted CA directory...

- task: AzureCLI@2
  displayName: Provision VM(s)
  inputs:
    azureSubscription: ${{ parameters.serviceConnectionName }}
    scriptType: 'bash'
    scriptLocation: 'inlineScript'
    inlineScript: |
      organizationName=$1
      location=$2
      subscription=$3
      environmentType=$4
      templateFilePath=$5
      sshPubKeyFilePath=$(caCertificate.secureFilePath)

      az deployment group create \
        --name agentVmDeployment \
        --no-prompt true \
        --location $location \
        --subscription $subscription \
        --template-file $templateFilePath \
        --parameters \
            environmentType=$environmentType \
            organization=$organizationName \
            adminPublicKey=$(cat ""$sshPubKeyFilePath) \
            existingSharedImageGalleryName='sig.contoso.images' \
            existingImageResourceGroupName='rg-contoso-images' \
            imageDefinitionName='ubuntu2004' \
            existingNetworkSecurityGroupName='nsg-agent' \
            existingSubnetName='snet-agent'
    arguments: >
      ${{ parameters.organizationName }}
      ${{ parameters.location }}
      ${{ parameters.subscription }}
      ${{ parameters.environmentType }}
      ${{ parameters.templateFilePath }}
      $(caCertificate.secureFilePath)



