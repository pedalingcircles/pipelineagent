parameters:
- name: storageAccountName
  type: string
- name: displayName
  type: string
  default: ''



- job: publishPackerImage
  displayName: Publish Packer Image
  timeoutInMinutes: 120 # 2 Hours

  steps:

  - script: echo Publishing image ${{ parameters.imageType }}
    displayName: Print Image Type

  # Setting the Capture Container Name for the Packer ARM builder.
  # This value represents the "directory" in the container where the
  # vhd blob exists. This is set based on the build number run so we can 
  # identify it among other images that are being built. In addition, you can 
  # set an override value if you choose not to run the long image building job and you 
  # already have a vhd built, but want to publish it. 
  # This task sets the 'captureContainerName' variable so subsequence tasks 
  # have it available.
  # see: https://www.packer.io/docs/builders/azure/arm#capture_container_name
  - pwsh: |
      $captureContainerNameOverride = "${{ parameters.storageAccountName }}"
      $captureContainerName = "$(Build.BuildNumber)"
      Write-Host "Initialize captureContainerName to $captureContainerName"
      Write-Host "Initialize captureContainerNameOverride to $captureContainerNameOverride"

      if ([string]::IsNullOrEmpty($captureContainerNameOverride) -eq $false) {
        Write-Host "captureContainerNameOverride value exists, overriding captureContainerName"
        $captureContainerName = $captureContainerNameOverride
      }
      
      # Packers requires the capture container name to follow the pattern ^[a-z0-9][a-z0-9\\-]{2,62}$
      $packerRegex = "^[a-z0-9][a-z0-9\\-]{2,62}$"
      $captureContainerName = $captureContainerName.ToLower() -replace "\.", "-"
      if (($captureContainerName -cmatch $packerRegex) -eq $false) {
        Write-Host "##vso[task.logissue type=error]captureContainerName:$captureContainerName doesn't match the pattern ^[a-z0-9][a-z0-9\\-]{2,62}$"
        exit 1
      }

      Write-Host "Setting variables captureContainerName to value $captureContainerName"
      Write-Host "##vso[task.setvariable variable=captureContainerName;]$captureContainerName"
    displayName: Generate Capture Container Name
    condition: false


# https://azure.microsoft.com/en-us/blog/azure-virtual-machine-internals-part-2/?cdn=disable
  - task: AzureCLI@2
    displayName: Convert to Managed Image
    condition: succeeded()
    inputs:
      azureSubscription: "AES JPS (New)"
      scriptType: pscore
      scriptLocation: inlineScript
      inlineScript: |
        $storageAccountName = "$(StorageAccountName)"
        Write-Host "storageAccountName=$storageAccountName"
        $captureContainerName = "$(captureContainerName)"
        Write-Host "captureContainerName=$captureContainerName"
        $containerName = "system"

        $prefix = "Microsoft.Compute/Images/images/{0}" -f $captureContainerName

        $prefix = "Microsoft.Compute/Images/{0}" -f $captureContainerName
        Write-Host "prefix=$prefix"
        $vhdName = az storage blob list --container-name $containerName --account-name $storageAccountName --prefix $prefix --query "[?contains(name, '.vhd')].name | [0]" -o tsv
        Write-Host "vhdName=$vhdName"
        $vhdDiskUri = "https://{0}.blob.core.windows.net/system/{1}" -f $storageAccountName, $vhdName
        Write-Host "vhdDiskUri=$vhdDiskUri"
        $imageName = "{0}-{1}-{2}.{3}" -f "packer", "${{ parameters.imageType }}", "$(dateVersion)", "$(dateVersionCounter)"
        Write-Host "imageName=$imageName"
        $id = az disk create --resource-group $(ResourceGroupName) --name $imageName --source $vhdDiskUri --query "id" -o tsv
        Write-Host "id=$id"
        az image create --resource-group $(ResourceGroupName) --name $imageName --os-type Linux --source $id
        Write-Host "Created managed image"
        Write-Host "##vso[task.setvariable variable=imageName;]$imageName"

  - task: AzureCLI@2
    displayName: Publish to Image Gallery
    condition: succeeded()
    inputs:
      azureSubscription: "AES JPS (New)"
      scriptType: pscore
      scriptLocation: inlineScript
      inlineScript: |
        $resourceGroupName = "$(ResourceGroupName)"
        $galleryName = "$(SharedImageGalleryName)"
        $imageDefinitionName = "${{ parameters.imageType }}"

        $imagePublisher = "$(ImagePublisher)"
        $imageOffer = "$(ImageOffer)"
        $imageSku = "${{ parameters.imageType }}"

        $osType = "${{ parameters.osType }}"
        $imageVersion = "$(versionSemantic)"
        Write-Host "imageVersion=$imageVersion"

        az sig image-definition create `
          --resource-group $resourceGroupName `
          --gallery-name $galleryName `
          --gallery-image-definition $imageDefinitionName `
          --publisher $imagePublisher `
          --offer $imageOffer `
          --sku $imageSku `
          --os-type $osType `
          --os-state Generalized

        $imageName = "$(imageName)"
        $imageId = az image list --resource-group $(ResourceGroupName) --query "[?contains(name, '$imageName')].id | [0]" -o tsv

        Write-Host "imageId=$imageId"

        az sig image-version create `
            --resource-group $resourceGroupName `
            --gallery-name $galleryName `
            --gallery-image-definition $imageDefinitionName `
            --gallery-image-version $imageVersion `
            --managed-image $imageId

  - task: PublishBuildArtifacts@1
    displayName: 'Publish Packer Results'
    condition: succeededOrFailed()
    inputs:
      PathtoPublish: '$(Pipeline.Workspace)'
      ArtifactName: drop-imagepublication
