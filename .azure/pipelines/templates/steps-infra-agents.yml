# steps-infra-agents-images.yml
# Description:
#   Steps template used to provision images infrastructure.

parameters:
# The environemnt type.
# Accepted values: sbx, prd
- name: environmentType
  type: string
  values:
  - ephemeral
  - sandbox
  - integration
  - development
  - demo
  - test
  - acceptance
  - staging
  - production

# The organization name.
- name: organizationName
  type: string

# The location.
- name: location
  type: string

# The subscription Id.
- name: subscription
  type: string

# The bicep template file path.
- name: templateFilePath
  type: string

# Service Connection name
- name: serviceConnectionName
  type: string

steps:
- task: AzureCLI@2
  displayName: Provision Infrastructure
  inputs:
    azureSubscription: ${{ parameters.serviceConnectionName }}
    scriptType: 'bash'
    scriptLocation: 'inlineScript'
    inlineScript: |
      organizationName=$1
      location=$2
      subscription=$3
      environmentType=$4
      templateFilePath=$5

      az deployment sub create \
        --name agentsDeployment \
        --no-prompt true \
        --location $location \
        --subscription $subscription \
        --template-file $templateFilePath \
        --parameters \
            environmentType=$environmentType \
            organization=$organizationName
    arguments: >
      ${{ parameters.organizationName }}
      ${{ parameters.location }}
      ${{ parameters.subscription }}
      ${{ parameters.environmentType }}
      ${{ parameters.templateFilePath }}
