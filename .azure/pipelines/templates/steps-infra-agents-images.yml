# job-vmimage-generation.yml
# Description:
#   Job template used to generate VM Images using Packer. Packer will drop 
#   the completed image as a VHD blob into a storage account and then the
#   job will optionally publish the image to an Azure Shared Image Gallery.
#
#  Notes:
#   This job template was originally derived and based on the job template used in the 
#   product team's actions/virtual-environments repo.
#   see: https://github.com/actions/virtual-environments/blob/main/images.CI/linux-and-win/azure-pipelines/image-generation.yml
#
#   Some notes from the original template:
#     Ideally we would use GitHub Actions for this, but since we use self-hosted machines to run image builds
#     we need the following features to use GitHub Actions for Images CI:
#     - https://github.community/t5/GitHub-Actions/Make-secrets-available-to-builds-of-forks/m-p/30678#M508
#     - https://github.community/t5/GitHub-Actions/GitHub-Actions-Manual-Trigger-Approvals/td-p/31504
#     - https://github.community/t5/GitHub-Actions/Protecting-github-workflows/td-p/30290

parameters:
# The environemnt type.
# Accepted values: sbx, prd
- name: environmentType
  type: string
  values:
  - sbx
  - prd

# The organization name.
- name: organizationName
  type: string

# The location.
- name: location
  type: string

# The subscription Id.
- name: subscription
  type: string

# The bicep template file path.
- name: templateFilePath
  type: string

# The template parameter file path.
- name: templateFileParameterPath
  type: string

steps:
- task: AzureCLI@2
  name: provisionImageInfrastructure
  displayName: Provision Image Infrastructure
  inputs:
    azureSubscription: rg-$(organizationName)-images-$(sandboxEnvironmentType)
    scriptType: bash
    scriptLocation: inlineScript
    inlineScript: |
      organizationName=$1
      location=$2
      subscription=$3
      environmentType=$4
      templateFilePath=$5
      templateFileParameterPath=$6

      resourceGroupName="rg-$organizationName-images-$environmentType"

      organizationName
      az group create \
        --name $resourceGroupName \
        --location $location

      az tag create \
        --resource-id /subscriptions/$subscription/resourcegroups/$resourceGroupName \
        --tags envtype=$environmentType use=images org=$organizationName

      az deployment group create \
        --resource-group $resourceGroupName \
        --template-file $templateFilePath \
        --parameters $templateFileParameterPath \
        --parameters organizationName=$(organizationName)
    arguments: >
      $(organizationName)
      $(location)
      $(subscription)
      $(sandboxEnvironmentType)
      $(templateFilePath)
      $(templateFileParameterPath)